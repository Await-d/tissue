import{aE as $,az as Q,aF as s,r as F,aG as I,aH as _,aI as E,aJ as L,aK as W,aq as p,$ as X,a8 as ue,ac as N,D as n,at as Y,H as se,J as G,ar as b,G as ie,ai as de,aL as le,aM as fe,aN as ce,a3 as oe,E as me}from"./index-QxN7NqSD.js";import{M as ge}from"./index-c3w7P-yv.js";import{I as pe}from"./index-DTsxH11M.js";var he=function(l,e){var d;e===void 0&&(e={});var a=e.defaultPageSize,m=a===void 0?10:a,j=e.defaultCurrent,t=j===void 0?1:j,w=$(e,["defaultPageSize","defaultCurrent"]),f=Q(l,s({defaultParams:[{current:t,pageSize:m}],refreshDepsAction:function(){y(1)}},w)),h=f.params[0]||{},C=h.current,D=C===void 0?1:C,v=h.pageSize,P=v===void 0?m:v,c=((d=f.data)===null||d===void 0?void 0:d.total)||0,A=F.useMemo(function(){return Math.ceil(c/P)},[P,c]),g=function(x,M){var R=x<=0?1:x,o=M<=0?1:M,U=Math.ceil(c/o);R>U&&(R=Math.max(1,U));var q=_(f.params||[]),T=q[0],O=T===void 0?{}:T,J=q.slice(1);f.run.apply(f,E([s(s({},O),{current:R,pageSize:o})],_(J),!1))},y=function(x){g(x,P)},S=function(x){g(D,x)};return s(s({},f),{pagination:{current:D,pageSize:P,total:c,totalPage:A,onChange:I(g),changeCurrent:I(y),changePageSize:I(S)}})},ve=function(l,e){var d;e===void 0&&(e={});var a=e.form,m=e.defaultType,j=m===void 0?"simple":m,t=e.defaultParams,w=e.manual,f=w===void 0?!1:w,h=e.refreshDeps,C=h===void 0?[]:h,D=e.ready,v=D===void 0?!0:D,P=$(e,["form","defaultType","defaultParams","manual","refreshDeps","ready"]),c=he(l,s(s({ready:v,manual:!0},P),{onSuccess:function(){for(var u,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];q.current=!0,(u=P.onSuccess)===null||u===void 0||u.call.apply(u,E([P],_(r),!1))}})),A=c.params,g=A===void 0?[]:A,y=c.run,S=g[2]||{},x=_(F.useState((S==null?void 0:S.type)||j),2),M=x[0],R=x[1],o=F.useRef({}),U=F.useRef([]),q=F.useRef(!1),T=!!(a!=null&&a.getInternalHooks),O=function(){if(!a)return{};if(T)return a.getFieldsValue(null,function(){return!0});var u=a.getFieldsValue(),r={};return Object.keys(u).forEach(function(i){(!a.getFieldInstance||a.getFieldInstance(i))&&(r[i]=u[i])}),r},J=function(){if(!a)return Promise.resolve({});var u=O(),r=Object.keys(u);return T?a.validateFields(r):new Promise(function(i,z){a.validateFields(r,function(V,K){V?z(V):i(K)})})},k=function(){if(a){if(T)return a.setFieldsValue(o.current);var u={};Object.keys(o.current).forEach(function(r){(!a.getFieldInstance||a.getFieldInstance(r))&&(u[r]=o.current[r])}),a.setFieldsValue(u)}},ee=function(){var u=O();o.current=s(s({},o.current),u),R(function(r){return r==="simple"?"advance":"simple"})},H=function(u){v&&setTimeout(function(){J().then(function(r){r===void 0&&(r={});var i=u||s(s({pageSize:e.defaultPageSize||10},(g==null?void 0:g[0])||{}),{current:1});if(!a){y(i);return}o.current=s(s({},o.current),r),y(i,r,{allFormData:o.current,type:M})}).catch(function(r){return r})})},ne=function(){var u,r;a&&a.resetFields(),H(s(s({},(t==null?void 0:t[0])||{}),{pageSize:e.defaultPageSize||((r=(u=e.defaultParams)===null||u===void 0?void 0:u[0])===null||r===void 0?void 0:r.pageSize)||10,current:1}))},ae=function(u){var r,i,z;(r=u==null?void 0:u.preventDefault)===null||r===void 0||r.call(u),H(q.current?void 0:s({pageSize:e.defaultPageSize||((z=(i=e.defaultParams)===null||i===void 0?void 0:i[0])===null||z===void 0?void 0:z.pageSize)||10,current:1},(t==null?void 0:t[0])||{}))},re=function(u,r,i,z){var V=_(g||[]),K=V[0],te=V.slice(1);y.apply(void 0,E([s(s({},K),{current:u.current,pageSize:u.pageSize,filters:r,sorter:i,extra:z})],_(te),!1))};F.useEffect(function(){if(g.length>0){o.current=(S==null?void 0:S.allFormData)||{},k(),y.apply(void 0,E([],_(g),!1));return}v&&(o.current=(t==null?void 0:t[1])||{},k(),H(t==null?void 0:t[0]))},[]),L(function(){v&&k()},[M]);var B=F.useRef(!1);return B.current=!1,L(function(){!f&&v&&(B.current=!0,a&&a.resetFields(),o.current=(t==null?void 0:t[1])||{},k(),H(t==null?void 0:t[0]))},[v]),L(function(){B.current||v&&(f||(B.current=!0,c.pagination.changeCurrent(1)))},E([],_(C),!1)),s(s({},c),{tableProps:{dataSource:((d=c.data)===null||d===void 0?void 0:d.list)||U.current,loading:c.loading,onChange:I(re),pagination:{current:c.pagination.current,pageSize:c.pagination.pageSize,total:c.pagination.total}},search:{submit:I(ae),type:M,changeType:I(ee),reset:I(ne)}})};async function xe(l,e){return{list:(await W.request({url:"/user/list",method:"get",params:{...l,...e}})).data.data,total:0}}function Z(l){return W.request({url:"/user/",method:l.id?"put":"post",data:l})}function je(){const[l]=p.useForm(),{userInfo:e}=X(t=>t.auth),{getInfo:d}=ue().auth,{run:a,loading:m}=Q(Z,{manual:!0,onSuccess:()=>{d(),N.success("保存成功")}});F.useEffect(()=>{e&&l.setFieldsValue(e)},[e]);function j(t){if(t.password&&t.password!==t.confirmPassword)return N.error("两次输入密码不一致");a({...t,id:e.id})}return n.jsx(Y,{title:"用户信息",children:n.jsxs(p,{form:l,layout:"vertical",onFinish:j,children:[n.jsxs(se,{gutter:20,children:[n.jsx(G,{span:24,lg:12,children:n.jsx(p.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:n.jsx(b,{})})}),n.jsxs(G,{span:24,lg:12,children:[n.jsx(p.Item,{name:"username",label:"用户名",rules:[{required:!0,message:"请输入用户名"}],children:n.jsx(b,{})})," "]}),n.jsxs(G,{span:24,lg:12,children:[n.jsx(p.Item,{name:"password",label:"新密码",children:n.jsx(b.Password,{})})," "]}),n.jsx(G,{span:24,lg:12,children:n.jsx(p.Item,{name:"confirmPassword",label:"确认新密码",children:n.jsx(b.Password,{})})})]}),n.jsx(ie,{type:"primary",htmlType:"submit",loading:m,children:"保存"})]})})}function Pe(l){const{form:e,initValues:d,...a}=l,m=d==null?void 0:d.id;return n.jsx(de,{title:m?"编辑用户":"新建用户",...a,children:n.jsxs(p,{layout:"vertical",form:e,children:[n.jsx(p.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:n.jsx(b,{})}),n.jsx(p.Item,{name:"username",label:"用户名",rules:[{required:!0,message:"请输入用户名"}],children:n.jsx(b,{})}),n.jsx(p.Item,{name:"password",label:"新密码",rules:[{required:!m}],children:n.jsx(b.Password,{})}),n.jsx(p.Item,{name:"confirmPassword",label:"确认新密码",rules:[{required:!m}],children:n.jsx(b.Password,{})})]})})}function Se(){const{message:l}=le.useApp(),{tableProps:e,refresh:d}=ve(xe),{setOpen:a,modalProps:m,form:j}=fe({service:Z,onOk:()=>{l.success("保存成功"),a(!1),d()}}),t=[{title:"名称",dataIndex:"name"},{title:"用户名",dataIndex:"username"},{title:"管理员",dataIndex:"is_admin",render:f=>f?"是":"否"},{title:"",dataIndex:"operations",width:20,render:(f,h)=>!h.is_admin&&n.jsx(ge,{onClick:C=>w(C,h)})}];function w(f,h){f==="edit"&&a(!0,h)}return n.jsxs(Y,{title:"用户管理",extra:n.jsx(pe,{onClick:()=>a(!0),children:n.jsx(ce,{})}),children:[n.jsx(oe,{rowKey:"id",columns:t,...e,pagination:!1}),n.jsx(Pe,{form:j,...m})]})}const ye=function(){const{userInfo:e}=X(d=>d.auth);return n.jsxs(me,{direction:"vertical",style:{width:"100%"},children:[n.jsx(je,{}),(e==null?void 0:e.is_admin)&&n.jsx(Se,{})]})};export{ye as component};
