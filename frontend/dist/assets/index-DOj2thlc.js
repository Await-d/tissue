import{aG as Q,aB as W,aH as i,r as _,aI as I,aJ as j,aK as R,aL as J,aM as X,as as g,a1 as Y,aa as se,F as a,av as Z,R as ie,G as H,at as b,O as ue,ae as N,ak as le,aN as oe,aO as de,a5 as ce,aP as fe,U as ve}from"./index-BQ4m4hxf.js";import{M as me}from"./index-BIy4NIlJ.js";import{I as ge}from"./index-DzFtCeiU.js";var pe=function(u,e){var o;e===void 0&&(e={});var r=e.defaultPageSize,v=r===void 0?10:r,P=e.defaultCurrent,n=P===void 0?1:P,w=Q(e,["defaultPageSize","defaultCurrent"]),d=W(u,i({defaultParams:[{current:n,pageSize:v}],refreshDepsAction:function(){y(1)}},w)),p=d.params[0]||{},C=p.current,T=C===void 0?1:C,h=p.pageSize,S=h===void 0?v:h,c=((o=d.data)===null||o===void 0?void 0:o.total)||0,U=_.useMemo(function(){return Math.ceil(c/S)},[S,c]),m=function(x,D){var V=x<=0?1:x,f=D<=0?1:D,E=Math.ceil(c/f);V>E&&(V=Math.max(1,E));var q=j(d.params||[]),M=q[0],O=M===void 0?{}:M,K=q.slice(1);d.run.apply(d,R([],j(R([i(i({},O),{current:V,pageSize:f})],j(K),!1)),!1))},y=function(x){m(x,S)},F=function(x){m(T,x)};return i(i({},d),{pagination:{current:T,pageSize:S,total:c,totalPage:U,onChange:I(m),changeCurrent:I(y),changePageSize:I(F)}})},he=function(u,e){var o;e===void 0&&(e={});var r=e.form,v=e.defaultType,P=v===void 0?"simple":v,n=e.defaultParams,w=e.manual,d=w===void 0?!1:w,p=e.refreshDeps,C=p===void 0?[]:p,T=e.ready,h=T===void 0?!0:T,S=Q(e,["form","defaultType","defaultParams","manual","refreshDeps","ready"]),c=pe(u,i(i({ready:h,manual:!0},S),{onSuccess:function(){for(var s,t=[],l=0;l<arguments.length;l++)t[l]=arguments[l];q.current=!0,(s=S.onSuccess)===null||s===void 0||s.call.apply(s,R([S],j(t),!1))}})),U=c.params,m=U===void 0?[]:U,y=c.run,F=m[2]||{},x=j(_.useState((F==null?void 0:F.type)||P),2),D=x[0],V=x[1],f=_.useRef({}),E=_.useRef([]),q=_.useRef(!1),M=!!(r!=null&&r.getInternalHooks),O=function(){if(!r)return{};if(M)return r.getFieldsValue(null,function(){return!0});var s=r.getFieldsValue(),t={};return Object.keys(s).forEach(function(l){(!r.getFieldInstance||r.getFieldInstance(l))&&(t[l]=s[l])}),t},K=function(){if(!r)return Promise.resolve({});var s=O(),t=Object.keys(s);return M?r.validateFields(t):new Promise(function(l,z){r.validateFields(t,function(A,L){A?z(A):l(L)})})},k=function(){if(r){if(M)return r.setFieldsValue(f.current);var s={};Object.keys(f.current).forEach(function(t){(!r.getFieldInstance||r.getFieldInstance(t))&&(s[t]=f.current[t])}),r.setFieldsValue(s)}},ee=function(){var s=O();f.current=i(i({},f.current),s),V(function(t){return t==="simple"?"advance":"simple"})},B=function(s){h&&setTimeout(function(){K().then(function(t){t===void 0&&(t={});var l=s||i(i({pageSize:e.defaultPageSize||10},(m==null?void 0:m[0])||{}),{current:1});if(!r){y(l);return}f.current=i(i({},f.current),t),y(l,t,{allFormData:f.current,type:D})}).catch(function(t){return t})})},ae=function(){var s,t;r&&r.resetFields(),B(i(i({},(n==null?void 0:n[0])||{}),{pageSize:e.defaultPageSize||((t=(s=e.defaultParams)===null||s===void 0?void 0:s[0])===null||t===void 0?void 0:t.pageSize)||10,current:1}))},re=function(s){var t,l,z;(t=s==null?void 0:s.preventDefault)===null||t===void 0||t.call(s),B(q.current?void 0:i({pageSize:e.defaultPageSize||((z=(l=e.defaultParams)===null||l===void 0?void 0:l[0])===null||z===void 0?void 0:z.pageSize)||10,current:1},(n==null?void 0:n[0])||{}))},te=function(s,t,l,z){var A=j(m||[]),L=A[0],ne=A.slice(1);y.apply(void 0,R([i(i({},L),{current:s.current,pageSize:s.pageSize,filters:t,sorter:l,extra:z})],j(ne),!1))};_.useEffect(function(){if(m.length>0){f.current=(F==null?void 0:F.allFormData)||{},k(),y.apply(void 0,R([],j(m),!1));return}h&&(f.current=(n==null?void 0:n[1])||{},k(),d||B(n==null?void 0:n[0]))},[]),J(function(){h&&k()},[D]);var G=_.useRef(!1);return G.current=!1,J(function(){!d&&h&&(G.current=!0,r&&r.resetFields(),f.current=(n==null?void 0:n[1])||{},k(),B(n==null?void 0:n[0]))},[h]),J(function(){G.current||h&&(d||(G.current=!0,e.refreshDepsAction?e.refreshDepsAction():c.pagination.changeCurrent(1)))},R([],j(C),!1)),i(i({},c),{tableProps:{dataSource:((o=c.data)===null||o===void 0?void 0:o.list)||E.current,loading:c.loading,onChange:I(te),pagination:{current:c.pagination.current,pageSize:c.pagination.pageSize,total:c.pagination.total}},search:{submit:I(re),type:D,changeType:I(ee),reset:I(ae)}})};async function xe(u,e){return{list:(await X.request({url:"/user/list",method:"get",params:{...u,...e}})).data.data,total:0}}function $(u){return X.request({url:"/user/",method:u.id?"put":"post",data:u})}function je(){const[u]=g.useForm(),{userInfo:e}=Y(n=>n.auth),{getInfo:o}=se().auth,{run:r,loading:v}=W($,{manual:!0,onSuccess:()=>{o(),N.success("保存成功")}});_.useEffect(()=>{e&&u.setFieldsValue(e)},[e]);function P(n){if(n.password&&n.password!==n.confirmPassword)return N.error("两次输入密码不一致");r({...n,id:e.id})}return a.jsx(Z,{title:"用户信息",children:a.jsxs(g,{form:u,layout:"vertical",onFinish:P,children:[a.jsxs(ie,{gutter:20,children:[a.jsx(H,{span:24,lg:12,children:a.jsx(g.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:a.jsx(b,{})})}),a.jsxs(H,{span:24,lg:12,children:[a.jsx(g.Item,{name:"username",label:"用户名",rules:[{required:!0,message:"请输入用户名"}],children:a.jsx(b,{})})," "]}),a.jsxs(H,{span:24,lg:12,children:[a.jsx(g.Item,{name:"password",label:"新密码",children:a.jsx(b.Password,{})})," "]}),a.jsx(H,{span:24,lg:12,children:a.jsx(g.Item,{name:"confirmPassword",label:"确认新密码",children:a.jsx(b.Password,{})})})]}),a.jsx(ue,{type:"primary",htmlType:"submit",loading:v,children:"保存"})]})})}function Pe(u){const{form:e,initValues:o,...r}=u,v=o==null?void 0:o.id;return a.jsx(le,{title:v?"编辑用户":"新建用户",...r,children:a.jsxs(g,{layout:"vertical",form:e,children:[a.jsx(g.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:a.jsx(b,{})}),a.jsx(g.Item,{name:"username",label:"用户名",rules:[{required:!0,message:"请输入用户名"}],children:a.jsx(b,{})}),a.jsx(g.Item,{name:"password",label:"新密码",rules:[{required:!v}],children:a.jsx(b.Password,{})}),a.jsx(g.Item,{name:"confirmPassword",label:"确认新密码",rules:[{required:!v}],children:a.jsx(b.Password,{})})]})})}function Se(){const{message:u}=oe.useApp(),{tableProps:e,refresh:o}=he(xe),{setOpen:r,modalProps:v,form:P}=de({service:$,onOk:()=>{u.success("保存成功"),r(!1),o()}}),n=[{title:"名称",dataIndex:"name"},{title:"用户名",dataIndex:"username"},{title:"管理员",dataIndex:"is_admin",render:d=>d?"是":"否"},{title:"",dataIndex:"operations",width:20,render:(d,p)=>!p.is_admin&&a.jsx(me,{onClick:C=>w(C,p)})}];function w(d,p){d==="edit"&&r(!0,p)}return a.jsxs(Z,{title:"用户管理",extra:a.jsx(ge,{onClick:()=>r(!0),children:a.jsx(fe,{})}),children:[a.jsx(ce,{rowKey:"id",columns:n,...e,pagination:!1}),a.jsx(Pe,{form:P,...v})]})}function ye(){const{userInfo:u}=Y(e=>e.auth);return a.jsxs(ve,{direction:"vertical",style:{width:"100%"},children:[a.jsx(je,{}),(u==null?void 0:u.is_admin)&&a.jsx(Se,{})]})}export{ye as component};
