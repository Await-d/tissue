# 版本管理和自动迁移功能 - 使用指南

## 📋 功能概述

版本管理和自动迁移功能已成功集成到Tissue-Plus项目中，提供了以下核心功能：

- **自动版本检测**: 每次启动时自动检测版本更新
- **自动数据库迁移**: 检测到版本更新时自动执行数据库迁移
- **版本历史记录**: 完整的版本更新和迁移历史
- **前端管理界面**: 直观的版本管理和监控界面
- **安全保障**: 迁移前置条件检查和错误处理

## 🚀 主要特性

### 1. 自动启动检测
- 应用每次启动时自动检测版本变化
- 对比当前代码版本与数据库存储版本
- 检测到更新时自动触发迁移流程

### 2. 智能迁移执行
- **前置条件检查**: 验证Alembic可用性、配置文件、数据库连接等
- **安全执行**: 支持数据库备份和回滚机制
- **错误处理**: 完善的错误捕获和日志记录
- **状态跟踪**: 实时记录迁移执行状态

### 3. 版本历史管理
- 记录每次版本更新的时间和状态
- 保存迁移成功/失败的详细信息
- 支持版本回滚和问题追踪

### 4. 管理界面
- **系统状态概览**: 健康度、版本信息、迁移状态
- **手动迁移控制**: 支持标准、快速、强制三种迁移模式
- **历史记录查看**: 完整的版本更新历史
- **实时监控**: 系统建议和问题诊断

## 📖 使用流程

### 自动流程（推荐）

1. **版本更新**: 开发者更新 `version.py` 中的版本号
2. **代码部署**: 部署新版本代码到服务器
3. **应用重启**: 重启应用服务
4. **自动检测**: 系统自动检测到版本更新
5. **自动迁移**: 自动执行数据库迁移
6. **状态记录**: 记录迁移结果和版本信息

### 手动管理流程

1. **访问管理界面**: 进入 `设置 → 版本管理`
2. **查看系统状态**: 检查版本信息和健康状态
3. **手动检查更新**: 点击"检查更新"按钮
4. **执行迁移**: 根据需要选择迁移模式
5. **监控结果**: 查看迁移执行结果和建议

## ⚙️ 配置说明

### 版本号格式
```python
# version.py
APP_VERSION = 'v0.1.0'
```

### 版本信息存储
```json
{
  "version": "v0.1.0",
  "updated_at": "2025-01-06T10:30:00",
  "migration_success": true,
  "notes": "自动升级到版本 v0.1.0",
  "previous_versions": [...]
}
```

### 迁移模式说明

#### 标准迁移（推荐）
- 执行完整的前置条件检查
- 自动创建数据库备份
- 安全执行数据库迁移
- 适用于生产环境

#### 快速迁移
- 跳过数据库备份步骤
- 执行基本前置条件检查
- 快速执行迁移
- 适用于开发环境

#### 强制迁移
- 忽略所有前置条件检查
- 强制执行迁移操作
- 仅在紧急情况下使用
- 需要管理员权限

## 🔧 API接口

### 获取版本信息
```http
GET /api/version/info
```

### 检查版本更新
```http
GET /api/version/check
```

### 执行数据库迁移
```http
POST /api/version/migrate
Content-Type: application/json

{
  "force_backup": true,
  "force_migration": false
}
```

### 获取版本历史
```http
GET /api/version/history
```

### 获取系统状态
```http
GET /api/version/status
```

### 检查迁移前置条件
```http
GET /api/version/requirements
```

## 🏗️ 技术实现

### 后端架构
```
app/
├── utils/version_manager.py        # 版本管理核心模块
├── startup.py                      # 启动前检查脚本
├── api/version.py                  # 版本管理API
└── main.py                         # 集成到启动流程
```

### 核心组件

#### VersionManager 类
- `is_version_updated()`: 检查版本是否更新
- `run_database_migration()`: 执行数据库迁移
- `check_migration_requirements()`: 检查前置条件
- `perform_auto_upgrade()`: 执行自动升级流程
- `get_version_info()`: 获取完整版本信息

#### 启动集成
```python
# app/main.py
@app.on_event("startup")
def on_startup():
    # 版本检测和自动迁移
    perform_version_check_and_migration()
    
    # 其他启动操作...
```

### 前端架构
```
frontend/src/
├── apis/version.ts                 # API接口定义
└── routes/_index/setting/version.tsx  # 管理界面
```

## 📊 监控和诊断

### 健康状态评分
- **优秀 (90-100%)**: 所有检查通过，系统状态良好
- **良好 (70-89%)**: 大部分检查通过，可正常运行
- **警告 (50-69%)**: 存在一些问题，需要关注
- **危险 (<50%)**: 存在严重问题，需要立即处理

### 状态检查项目
1. **版本一致性**: 当前版本与存储版本是否一致
2. **迁移成功性**: 上次迁移是否成功
3. **Alembic可用性**: 迁移工具是否可用
4. **配置文件**: alembic.ini是否存在
5. **数据库访问**: 数据库连接是否正常
6. **磁盘空间**: 是否有足够的磁盘空间

### 日志查看
```bash
# 查看应用日志
tail -f logs/app.log

# 查看版本管理相关日志
grep "version_manager\|VersionManager\|version.*update" logs/app.log

# 查看迁移执行日志
grep "migration\|alembic\|upgrade" logs/app.log
```

## 🚨 故障排除

### 常见问题

**1. 版本检测失败**
```
症状: 系统显示版本检测失败
原因: 版本文件读取权限问题
解决: 检查 version.py 文件权限和 data/ 目录权限
```

**2. 迁移执行失败**
```
症状: 数据库迁移执行失败
原因: Alembic配置错误或数据库连接问题
解决: 
- 检查 alembic.ini 配置
- 验证数据库连接字符串
- 手动执行 alembic upgrade head
```

**3. 前置条件检查失败**
```
症状: 前置条件检查不通过
原因: 缺少必要的依赖或配置
解决:
- 安装 alembic: pip install alembic
- 检查配置文件是否存在
- 确认数据库服务正常运行
```

**4. 版本信息不一致**
```
症状: 界面显示版本信息不一致
原因: 版本记录文件损坏或丢失
解决: 使用"强制保存版本"功能重置版本记录
```

### 紧急恢复

#### 重置版本记录
```python
# 进入Python环境
from app.utils.version_manager import version_manager
version_manager.save_version_info(
    version="当前版本",
    migration_success=True,
    notes="手动重置版本记录"
)
```

#### 跳过版本检查
```python
# 临时修改启动流程
# 在 app/main.py 中注释掉版本检查调用
# perform_version_check_and_migration()
```

## 📈 最佳实践

### 开发环境
1. **频繁更新**: 使用快速迁移模式
2. **测试验证**: 每次迁移后验证功能正常
3. **备份习惯**: 重要变更前手动备份数据库

### 生产环境
1. **标准流程**: 始终使用标准迁移模式
2. **维护窗口**: 在维护时间窗口执行更新
3. **监控告警**: 设置版本状态监控告警
4. **回滚准备**: 准备数据库回滚方案

### 版本管理
1. **语义化版本**: 使用语义化版本号 (v主版本.次版本.修订号)
2. **变更日志**: 记录每个版本的主要变更
3. **迁移测试**: 在测试环境充分测试迁移脚本
4. **渐进部署**: 采用蓝绿部署或滚动更新

## 🔄 升级流程

### 从旧版本升级

1. **备份数据**: 手动备份当前数据库
2. **更新代码**: 部署新版本代码
3. **首次启动**: 系统会自动检测并执行迁移
4. **验证功能**: 检查所有功能正常运行
5. **监控状态**: 使用版本管理界面监控系统状态

### 版本回退

1. **停止服务**: 停止应用服务
2. **恢复代码**: 回退到之前的代码版本
3. **恢复数据库**: 从备份恢复数据库
4. **重置版本记录**: 手动重置版本信息
5. **重启验证**: 重启服务并验证功能

## 📝 开发指南

### 添加新迁移

1. **创建迁移文件**:
```bash
alembic revision --autogenerate -m "描述变更"
```

2. **更新版本号**:
```python
# version.py
APP_VERSION = 'v0.2.0'  # 递增版本号
```

3. **测试迁移**:
```bash
alembic upgrade head
```

4. **部署和验证**: 部署后验证自动迁移功能

### 自定义迁移逻辑

```python
# 扩展 VersionManager 类
class CustomVersionManager(VersionManager):
    def custom_migration_logic(self):
        # 自定义迁移前后的处理逻辑
        pass
```

---

**版本**: v1.0.0  
**最后更新**: 2025-01-06  
**维护者**: Tissue-Plus Team