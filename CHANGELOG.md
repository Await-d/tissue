# Tissue-Plus 更新日志

## [v0.1.4] - 2025-11-13

### ✨ 新增功能

#### 订阅系统增强
- **🎯 订阅关键字过滤** - 精准控制订阅内容
  - **包含关键字**: 只下载标题包含指定关键字的影片（如"单体"）
  - **排除关键字**: 排除标题包含指定关键字的影片（支持正则表达式，如"VR|精选"）
  - **智能匹配**: 大小写不敏感的正则表达式匹配
  - **异常保护**: 无效正则表达式不会导致订阅任务崩溃

- **📜 订阅历史管理** - 追踪已完成的订阅
  - 查看历史订阅记录（按时间倒序）
  - 一键重新订阅已完成的演员
  - 状态追踪（活跃/已完成）

#### 搜索体验优化
- **🔍 番号搜索历史** - 快速重复查询
  - 自动保存最近10次搜索记录
  - 点击历史记录即可快速搜索
  - 刷新页面自动恢复上次搜索的番号
  - LocalStorage持久化存储

#### 上游功能合并
- **📦 Jellyfin NFO兼容性修复** - 支持新版本Jellyfin
  - NFO根元素从`Root`改为`movie`
  - 生成`movie.nfo`文件以兼容新版Jellyfin
  - 删除时自动清理`movie.nfo`

- **🖼️ 图像处理库迁移** - 减少依赖和镜像体积
  - 从OpenCV迁移到Pillow (pillow==11.2.1)
  - 移除numpy和opencv-python-headless依赖
  - Docker镜像体积减少约200MB
  - 改进资源管理（使用context managers）

### 🔒 安全性增强

- **Token有效期优化** - 从365天调整为30天，符合安全最佳实践
- **正则表达式注入防护** - 防止恶意正则导致ReDoS攻击
- **数据库事务保护** - 订阅下载失败时自动回滚状态更新
- **登录状态管理** - 修复退出登录时pin不清除的问题

### 🛠️ 技术改进

#### 数据库层
- 新增 `include_keyword` 字段 - 包含关键字过滤
- 新增 `exclude_keyword` 字段 - 排除关键字过滤
- 新增 `status` 字段 - 订阅状态管理（1=活跃, 2=已完成）
- 新增 `update_time` 字段 - 订阅完成时间追踪
- 合并数据库迁移分支，解决多头问题

#### 后端服务
- 改进DMM spider异常处理（GraphQL API验证）
- 优化订阅服务正则表达式安全性
- 添加订阅历史查询API
- 添加重新订阅功能API
- 改进错误日志和异常处理

#### 前端界面
- 新增订阅历史模态框组件
- 新增搜索历史模态框组件
- 优化订阅表单（关键字输入）
- 改进登录状态管理
- 响应式设计优化

### 🔧 API 接口

**新增接口**:
- `GET /api/subscribe/histories` - 获取订阅历史记录
- `POST /api/subscribe/resubscribe` - 重新订阅

**更新接口**:
- `POST /api/subscribe` - 支持包含/排除关键字参数
- `PUT /api/subscribe/{id}` - 支持更新关键字过滤条件

### 🐛 修复问题

- 修复订阅update_time字段缺失导致的运行时错误
- 修复正则表达式异常未捕获导致的订阅任务崩溃
- 修复订阅下载失败时状态未回滚的数据不一致问题
- 修复DMM spider缺少异常处理的问题
- 修复图像文件句柄未正确关闭的资源泄漏问题
- 修复Jellyfin新版本不读取视频同名NFO的兼容性问题

### 📋 升级指南

#### 数据库迁移
本版本会自动执行数据库迁移，包括：
- 添加订阅关键字过滤字段
- 添加订阅状态管理字段
- 添加订阅时间追踪字段

迁移过程自动完成，无需手动操作。建议升级前备份数据。

#### Docker镜像更名
⚠️ **重要变更**: Docker镜像名从 `await2719/tissue` 改为 `await2719/tissue-plus`

更新方式：
```bash
# 停止旧容器
docker stop tissue
docker rm tissue

# 拉取新镜像
docker pull await2719/tissue-plus:latest

# 使用新镜像名运行
docker run -d --name tissue-plus ... await2719/tissue-plus:latest
```

#### 配置兼容性
- 所有配置文件完全向后兼容
- 旧版本配置无需修改即可使用
- 新功能默认禁用，可按需开启

### 🎉 功能亮点

- **更精准的订阅**: 关键字过滤让订阅更符合个人需求
- **更友好的体验**: 搜索历史和订阅历史提升效率
- **更安全的系统**: 多重安全机制保护数据和服务
- **更小的体积**: 镜像体积减少约200MB
- **更好的兼容**: 支持最新版Jellyfin媒体服务器

---

## [v0.1.3] - 2025-07-12

### ✨ 新增功能
- **智能下载过滤系统** - 全新的种子文件过滤功能
  - 🎯 **磁力链接解析**: 支持解析磁力链接基本信息 (Hash, 名称, 大小)
  - 🧠 **智能文件识别**: 自动识别视频、字幕、样本文件等类型
  - 📏 **文件大小过滤**: 可设置最小/最大文件大小限制
  - 🎭 **样本文件过滤**: 智能识别并跳过sample、preview等无用文件
  - 🎬 **媒体文件模式**: 新增专门针对视频+字幕的过滤模式
  - 📄 **字幕控制**: 可单独控制是否包含字幕文件
  - 🔧 **实时测试**: 支持测试磁力链接的过滤效果
  - 🚀 **自动生效**: 新种子自动应用过滤规则
  - 🗄️ **自动迁移**: 程序启动时自动创建数据库表和字段

### 🛠️ 技术改进
- **数据库层**
  - 新增 `download_filter_settings` 表存储过滤配置
  - 自动数据库迁移系统，无需手动SQL操作
  - 新增 `media_files_only` 和 `include_subtitles` 字段

- **后端服务**
  - 新增 `TorrentParser` 种子文件解析器
  - 新增 `DownloadFilterService` 过滤业务服务
  - 扩展 qBittorrent 集成，支持文件优先级设置
  - 完整的 RESTful API 接口 (`/api/download-filter/*`)

- **前端界面**
  - 新增下载过滤设置页面 (`/setting/download-filter`)
  - TypeScript 类型安全的实现
  - 实时磁力链接测试功能
  - 响应式表单设计和智能提示

### 🔧 API 接口
- `GET /api/download-filter/settings` - 获取过滤设置
- `POST /api/download-filter/settings` - 保存过滤设置
- `POST /api/download-filter/test-magnet` - 测试磁力链接过滤
- `POST /api/download-filter/filter-torrent` - 对已存在种子应用过滤
- `GET /api/download-filter/statistics` - 获取过滤统计信息

### 📋 使用场景
- **精确过滤**: 只下载大于300MB的主要视频文件
- **媒体收集**: 保留视频文件和字幕文件，过滤其他类型
- **带宽节省**: 智能跳过样本文件和宣传内容
- **存储优化**: 根据文件大小自动筛选内容

### 🎉 功能亮点
- **零配置**: 程序启动自动初始化，无需用户干预
- **智能化**: 基于文件名和大小的多维度智能分析
- **可视化**: 直观的设置界面和实时测试反馈
- **兼容性**: 与现有下载系统完美集成，无破坏性更改

---

## [v0.1.2] - 2025-07-10

### 🐛 修复问题
- 修复智能下载重试功能和优化手机端界面
- 修复演员订阅任务中的NameError
- 修复演员订阅下载记录问题
- 修复演员订阅字段兼容性问题

### ⚡ 性能优化
- 优化演员作品列表获取性能
- 增强演员订阅筛选逻辑的调试日志
- 优化智能下载规则获取视频逻辑

### 🔧 技术改进
- 添加专用生产环境数据库修复脚本
- 添加生产环境数据库修复工具
- 修复API中status变量名冲突导致的生产环境错误

---

## [v0.1.1] - 2025-07-10

### 🎯 初始版本功能
- 基础的JAV元数据刮削功能
- 演员订阅系统
- 智能下载规则
- Web管理界面
- qBittorrent集成

### 📝 说明
- 基于 chris-2s/tissue 项目深度改进
- 提供完整的媒体库管理解决方案
- 支持 Jellyfin、Emby、Kodi 等媒体服务器集成