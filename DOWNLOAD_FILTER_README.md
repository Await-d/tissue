# 资源下载过滤功能 - 设计文档和使用说明

## 功能概述

资源下载过滤功能是一个智能的种子文件筛选系统，能够：

1. **分析种子内容**：解析种子文件，获取文件列表和大小信息
2. **智能过滤**：根据文件大小、类型等条件过滤文件
3. **自动配置下载**：只下载符合条件的文件，跳过不需要的内容
4. **前端管理界面**：提供直观的设置和测试界面
5. **自动数据库迁移**：程序启动时自动创建所需的数据库表和字段

## 架构设计

### 1. 数据库层
- **新增表**: `download_filter_settings` - 存储过滤配置
- **字段**: 文件大小限制、智能过滤开关、扩展名过滤等
- **自动迁移**: 程序启动时自动检查和创建表结构

### 2. 后端服务层
- **TorrentParser**: 种子文件解析和分析
- **DownloadFilterService**: 过滤业务逻辑服务
- **数据库迁移工具**: 自动管理数据库结构变更
- **qBittorrent集成**: 文件优先级设置

### 3. API接口层
- `/api/download-filter/settings` - 获取/保存过滤设置
- `/api/download-filter/test-magnet` - 测试磁力链接过滤效果
- `/api/download-filter/filter-torrent` - 对已存在种子应用过滤
- `/api/download-filter/statistics` - 过滤统计信息

### 4. 前端界面层
- **设置页面**: `/setting/download-filter`
- **实时测试**: 磁力链接过滤效果预览
- **统计显示**: 过滤效果和文件信息展示

## 核心文件说明

### 后端文件

1. **`app/db/models/download_filter.py`** - 数据库模型
   - `DownloadFilterSettings` 模型定义
   - 包含所有过滤配置字段

2. **`app/utils/torrent_parser.py`** - 种子解析器
   - 解析qBittorrent API返回的文件列表
   - 智能识别视频、样本、字幕文件
   - 应用各种过滤规则

3. **`app/utils/db_migration.py`** - 数据库迁移工具
   - 自动检查表和字段是否存在
   - 创建缺失的数据库结构
   - 初始化默认设置

4. **`app/service/download_filter.py`** - 过滤服务
   - 过滤业务逻辑实现
   - qBittorrent文件优先级设置
   - 磁力链接分析和过滤

5. **`app/api/download_filter.py`** - API接口
   - RESTful API端点定义
   - 请求/响应模型
   - 错误处理

6. **`app/utils/qbittorent.py`** - qBittorrent客户端扩展
   - 新增文件优先级设置方法
   - 批量文件操作支持

### 前端文件

1. **`frontend/src/apis/downloadFilter.ts`** - API接口定义
   - TypeScript类型定义
   - API调用方法

2. **`frontend/src/routes/_index/setting/download-filter.tsx`** - 设置界面
   - 过滤参数配置表单
   - 磁力链接测试功能
   - 实时结果展示

## 使用流程

### 1. 配置过滤规则
1. 打开设置页面 → 下载过滤
2. 设置最小文件大小（默认300MB）
3. 选择是否启用智能过滤
4. 配置其他过滤选项
5. 保存设置

### 2. 测试过滤效果
1. 点击"测试过滤"按钮
2. 输入磁力链接
3. 查看过滤结果和文件列表
4. 确认过滤效果是否符合预期

### 3. 自动生效
- 新添加的种子会自动应用过滤规则
- 只有符合条件的文件会被下载
- 不符合条件的文件会被跳过

## 过滤规则说明

### 文件大小过滤
- **最小文件大小**: 小于此大小的文件被过滤
- **最大文件大小**: 大于此大小的文件被过滤（可选）

### 智能过滤
- **样本文件过滤**: 自动识别并跳过sample、preview等样本文件
- **字幕文件过滤**: 跳过纯字幕文件（.srt, .ass等）
- **宣传文件过滤**: 跳过网站宣传文件

### 文件类型过滤
- **视频优先**: 默认只保留视频文件
- **扩展名过滤**: 支持白名单/黑名单模式（后续扩展）

## 技术特点

### 1. 自动化部署
- 程序启动时自动检查数据库结构
- 无需手动执行SQL脚本
- 向后兼容，不影响现有功能

### 2. 智能识别
- 基于文件名和扩展名的智能分类
- 样本文件关键词检测
- 文件大小合理性判断

### 3. 实时生效
- 配置更改立即生效
- 支持热重载配置
- 无需重启服务

### 4. 用户友好
- 直观的界面设计
- 实时测试功能
- 详细的结果展示

## 开发扩展

### 添加新的过滤规则
1. 在 `TorrentParser` 中添加新的过滤方法
2. 在数据库模型中添加相应配置字段
3. 更新API接口和前端界面
4. 在迁移工具中添加字段检查

### 支持新的文件类型
1. 更新 `VIDEO_EXTENSIONS` 等常量
2. 添加新的文件类型判断逻辑
3. 更新前端显示和提示

## 注意事项

1. **数据库权限**: 确保应用有创建表和字段的权限
2. **qBittorrent版本**: 建议使用较新版本的qBittorrent
3. **磁力链接格式**: 支持标准的btih格式磁力链接
4. **文件大小单位**: 所有大小配置均以MB为单位

## 故障排除

### 数据库迁移失败
- 检查数据库连接配置
- 确认数据库用户权限
- 查看详细错误日志

### 过滤不生效
- 检查过滤设置是否正确保存
- 确认qBittorrent连接正常
- 查看种子文件是否支持优先级设置

### 前端界面异常
- 检查API接口是否正常
- 确认路由配置正确
- 查看浏览器控制台错误

## 版本信息

- **开发版本**: v1.0.0
- **兼容性**: Tissue-Plus v0.0.3+
- **数据库**: MySQL 5.7+
- **qBittorrent**: 4.0+

## 后续计划

1. **高级过滤规则**: 基于文件内容的深度分析
2. **批量操作**: 对已存在种子批量应用过滤
3. **统计分析**: 详细的过滤效果统计报表
4. **规则模板**: 预设的常用过滤规则模板