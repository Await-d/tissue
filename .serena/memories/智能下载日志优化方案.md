# 智能下载日志锁死问题优化方案

## 问题分析
1. **日志系统锁死**：智能规则下载时产生大量日志，RotatingFileHandler在高并发时容易锁死
2. **前端无法查看日志**：日志文件被长时间占用，前端无法正常读取
3. **调试信息过多**：大量无用的调试日志影响性能

## 解决方案

### 1. 异步日志管理器 (async_logger.py)
- **异步队列处理**：文件日志通过队列异步写入，避免阻塞
- **控制台直接输出**：终端日志不经过队列，保持实时性
- **队列溢出保护**：队列满时丢弃日志，避免内存溢出

### 2. 智能下载专用日志器 (SmartDownloadLogger)
- **重要日志优先**：只记录包含关键词的重要日志
- **批量处理**：次要日志批量处理，减少IO操作
- **上下文感知**：自动识别智能下载场景

### 3. 日志输出优化
- **减少调试信息**：移除video_collector中的debug日志
- **延迟日志筛选**：只在延迟较长时记录等待信息
- **批量刷新**：任务完成后统一刷新批量日志

### 4. 文件处理优化
- **追加模式**：使用'a'模式而非'w'模式，减少文件锁冲突
- **增大文件限制**：提高maxBytes和backupCount
- **daemon线程**：日志处理线程设为守护线程

## 使用方法
```python
# 自动选择合适的日志器
from app.utils.async_logger import get_logger
logger = get_logger()

# 手动使用异步日志器
from app.utils.async_logger import AsyncLoggerManager
logger = AsyncLoggerManager()
```

## 预期效果
1. 解决日志锁死问题
2. 减少50%以上的日志输出量
3. 提高智能下载性能
4. 前端可正常查看日志